ho INSTALLATION INSTRUCTIONS
=========================

Prerequisites
-------------
1. Ensure you have root or sudo access
2. A working Rocky Linux/AlmaLinux/RHEL 8+ system

Installation Steps
------------------

1. Install EPEL Repository and Enable Modules
   ------------------------------------------
   sudo dnf -y install epel-release
   sudo dnf module reset php
   sudo dnf -y module enable php:8.2
   sudo dnf config-manager --set-enabled powertools
   sudo dnf -y update
   if Almalinux 9:
      sudo dnf -y install wget 
      sudo rpm -Uvh https://dl.fedoraproject.org/pub/epel/8/Everything/x86_64/Packages/s/sipcalc-1.1.6-17.el8.x86_64.rpm

2. Install IpDatabase RPM
   -----------------------
   sudo dnf install IpDatabase-.....rpm

3. SELinux Configuration (Optional - for ping functionality)
   ---------------------------------------------------------
   # To temporarily disable SELinux:
   sudo setenforce 0
   sudo sed -i -E 's/^(SELINUX=)\s*enforcing/\1permissive/' /etc/selinux/config

4. Database Installation and Configuration
   ---------------------------------------
   sudo dnf -y module reset postgresql
   sudo dnf -y module enable postgresql:16  # Version 15 is also acceptable
   sudo dnf install -y postgresql-server postgresql-contrib
   sudo /usr/bin/postgresql-setup --initdb --unit postgresql
   
   # Edit authentication method:
   sudo sed -i -E '/^host\s+all\s+all\s+(127\.0\.0\.1\/32|::1\/128)\s+ident$/s/ident$/md5/' /var/lib/pgsql/data/pg_hba.conf
    
   sudo systemctl enable --now postgresql
   
5. Database User and Schema Setup
   -------------------------------
   DB_PASS=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c32)
   sudo -u postgres psql -c "CREATE USER ipv2 WITH PASSWORD '$DB_PASS';"
   su - postgres -c "createdb -O ipv2 ipv2"
   sudo -iu ipv2 psql ipv2 -c "CREATE EXTENSION pg_trgm;"
   sudo -iu ipv2 psql ipv2 -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
   # Import database schema and data
   sudo -iu ipv2 psql ipv2 < /home/ipv2/ipv2_schema.sql
   sudo -iu ipv2 psql ipv2 < /home/ipv2/ipdatabase.sql
   sudo -iu ipv2 psql ipv2 < /home/ipv2/bootstrap.sql
   sudo -iu ipv2 psql ipv2 < /home/ipv2/global_config.sql

6. Configuration Files
   --------------------
   # Web configuration
   sudo cp /var/www/html/config.php.sample /var/www/html/config.php
   RANDOM_STR=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c64)
   sudo sed -i "s/\$secret=\"change this to a random string\";/\$secret=\"$RANDOM_STR\";/" /var/www/html/config.php
   sudo sed -i "/^\$password\s*=/s/=.*$/= '$DB_PASS';/" /var/www/html/config.php   
   
   # Application configuration
   sudo cp /home/ipv2/bin/config.txt.sample /home/ipv2/bin/config.txt
   sudo sed -i "/^\$password\s*=/s/=.*$/= '$DB_PASS';/" /home/ipv2/bin/config.txt

7. Enable Services
   ----------------
   sudo systemctl daemon-reload
   sudo systemctl enable --now watch-archive-dir.service
   sudo systemctl enable --now watch-jtac-dir.service
   sudo systemctl enable --now watch-scan-dir.service
   sudo systemctl enable --now watch-switch-port_names.service
   sudo -u ipv2 crontab /home/ipv2/crontab
   sudo -u root crontab /home/ipv2/root-crontab

8. PHP Dependencies
   -----------------
   sudo dnf -y install composer
   cd /var/www/html
   sudo composer require influxdb/influxdb-php

9. Initial Setup
   --------------
   # Change admin password
   sudo -u ipv2 php /home/ipv2/bin/change_user_password.php username=admin new_password=new_password
   
   # Browse to your server:
   # http://your-server-ip
   # Login with: admin / new_password

Troubleshooting
---------------
- If services fail to start, check journalctl for specific service errors
- Ensure firewall allows HTTP/HTTPS traffic if accessing remotely
- Verify PostgreSQL is running: sudo systemctl status postgresql
- Check web server configuration if unable to access web interface

Support
-------
For issues, please check the documentation or open an issue in the repository.
